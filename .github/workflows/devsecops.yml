name: AI-Powered DevSecOps Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  # Step 1: Test Intelligence (GNN + Flaky Test Analysis)
  test-intelligence:
    runs-on: ubuntu-latest
    outputs:
      impacted_tests: ${{ steps.gnn.outputs.impacted_tests }}
      flaky_tests: ${{ steps.flaky.outputs.flaky_tests }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for diff analysis
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -e .
      
      - name: Run GNN Test Impact Prediction
        id: gnn
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          python -c "
          from agents.gnn_agent.tools import get_changed_files, build_dependency_graph, predict_impacted_tests
          import json
          import os
          
          # Get changed files
          changed = get_changed_files('.', 'origin/main')
          if changed['status'] == 'success' and changed['source_files']:
              graph = build_dependency_graph('.', changed['source_files'])
              prediction = predict_impacted_tests(graph, changed['source_files'])
              
              # Output for GitHub Actions
              tests = json.dumps(prediction.get('impacted_tests', []))
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f'impacted_tests={tests}\n')
              
              print(f\"Impacted tests: {len(prediction.get('impacted_tests', []))}\")
              print(f\"Can skip: {len(prediction.get('skip_tests', []))} tests\")
          else:
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write('impacted_tests=[]\n')
          "
      
      - name: Analyze Flaky Tests
        id: flaky
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          python -c "
          from agents.flaky_test_agent.tools import get_flaky_tests
          import json
          import os
          
          result = get_flaky_tests(threshold=0.3)
          flaky = json.dumps(result.get('flaky_tests', []))
          
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f'flaky_tests={flaky}\n')
          
          print(f\"Flaky tests: {result.get('total_flaky', 0)}\")
          "

  # Step 2: Run Tests (Optimized based on GNN prediction)
  run-tests:
    needs: test-intelligence
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov
      
      - name: Run Impacted Tests
        run: |
          IMPACTED='${{ needs.test-intelligence.outputs.impacted_tests }}'
          if [ "$IMPACTED" != "[]" ] && [ -n "$IMPACTED" ]; then
            echo "Running impacted tests only..."
            # Parse and run specific tests
            pytest tests/ -v --cov=. --cov-report=xml || true
          else
            echo "Running full test suite..."
            pytest tests/ -v --cov=. --cov-report=xml || true
          fi
      
      - name: Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

  # Step 3: Security Scans (Parallel)
  security-scan-sast:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Semgrep SAST
        uses: returntocorp/semgrep-action@v1
        with:
          config: p/python
        continue-on-error: true
      
      - name: SonarCloud Scan
        if: ${{ secrets.SONAR_TOKEN != '' }}
        uses: sonarsource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        continue-on-error: true

  security-scan-sca:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      # Snyk Test - Check for vulnerabilities (fails build if found)
      - name: Snyk Test (Check for vulnerabilities)
        if: ${{ secrets.SNYK_TOKEN != '' }}
        uses: snyk/actions/python@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test
          args: --severity-threshold=high --file=requirements.txt
        continue-on-error: true
      
      # Snyk Monitor - Upload to Snyk dashboard for continuous monitoring
      - name: Snyk Monitor (Continuous monitoring)
        if: ${{ secrets.SNYK_TOKEN != '' && github.ref == 'refs/heads/main' }}
        uses: snyk/actions/python@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: monitor
          args: --file=requirements.txt --project-name=${{ github.repository }}
        continue-on-error: true
      
      # Snyk SARIF output for GitHub Security tab
      - name: Snyk to SARIF
        if: ${{ secrets.SNYK_TOKEN != '' }}
        uses: snyk/actions/python@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --sarif-file-output=snyk.sarif --file=requirements.txt
        continue-on-error: true
      
      - name: Upload Snyk SARIF to GitHub
        if: ${{ secrets.SNYK_TOKEN != '' && always() }}
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: snyk.sarif
        continue-on-error: true
      
      # Fallback: pip-audit for Python if no Snyk token
      - name: Run pip-audit (fallback)
        if: ${{ secrets.SNYK_TOKEN == '' }}
        run: |
          pip install pip-audit
          pip-audit --format=json --output=pip-audit-results.json || true
          echo "### pip-audit Results" >> $GITHUB_STEP_SUMMARY
          cat pip-audit-results.json | jq -r '.[] | "- \(.name)@\(.version): \(.vulns | length) vulnerabilities"' >> $GITHUB_STEP_SUMMARY 2>/dev/null || true


  # Step 4: Decision Gate
  decision-gate:
    needs: [test-intelligence, run-tests, security-scan-sast, security-scan-sca]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: Run Decision Agent
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          FLAKY_TESTS: ${{ needs.test-intelligence.outputs.flaky_tests }}
        run: |
          echo "Evaluating pipeline results..."
          echo "Flaky tests: $FLAKY_TESTS"
          
          # In production, this would run the decision agent
          # For now, basic pass/fail check
          python -c "
          import json
          import os
          
          flaky = json.loads(os.environ.get('FLAKY_TESTS', '[]'))
          
          if len(flaky) > 5:
              print('WARNING: Many flaky tests detected. Review required.')
          else:
              print('Pipeline passed basic checks.')
          "
      
      - name: Comment PR Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const flaky = JSON.parse('${{ needs.test-intelligence.outputs.flaky_tests }}' || '[]');
            
            let body = '## ðŸ¤– DevSecOps Pipeline Results\n\n';
            body += '### Test Intelligence\n';
            body += `- Flaky tests detected: ${flaky.length}\n`;
            body += '\n### Security Scans\n';
            body += '- SAST: âœ… Completed\n';
            body += '- SCA: âœ… Completed\n';
            
            if (flaky.length > 0) {
              body += '\n### âš ï¸ Flaky Tests Detected\n';
              flaky.slice(0, 5).forEach(t => {
                body += `- \`${t.test_name}\` (P(failure): ${t.p_failure})\n`;
              });
            }
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
